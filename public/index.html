<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SecureTalk Edu - Working Version</title>
    <style>
        /* Complete CSS in one file */
        :root {
            --bg-primary: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --bg-secondary: rgba(255, 255, 255, 0.95);
            --bg-card: rgba(255, 255, 255, 0.98);
            --text-primary: #2d3748;
            --text-secondary: #4a5568;
            --text-muted: #718096;
            --text-inverse: #ffffff;
            --border-color: rgba(226, 232, 240, 0.8);
            --border-focus: #667eea;
            --accent-primary: linear-gradient(45deg, #667eea, #764ba2);
            --accent-success: linear-gradient(45deg, #48bb78, #38a169);
            --status-online: #48bb78;
            --status-offline: #a0aec0;
            --status-error: #f56565;
            --neon-cyan: #00f5ff;
        }

        [data-theme="dark"] {
            --bg-primary: linear-gradient(135deg, #1a202c 0%, #2d3748 100%);
            --bg-secondary: rgba(26, 32, 44, 0.95);
            --bg-card: rgba(45, 55, 72, 0.98);
            --text-primary: #f7fafc;
            --text-secondary: #e2e8f0;
            --text-inverse: #1a202c;
            --border-color: rgba(74, 85, 104, 0.6);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: var(--bg-primary);
            min-height: 100vh;
            color: var(--text-primary);
            line-height: 1.6;
            transition: all 0.3s ease;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .theme-toggle {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
        }

        .theme-btn {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 12px 16px;
            background: var(--bg-card);
            border: 2px solid var(--border-color);
            border-radius: 25px;
            color: var(--text-primary);
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .theme-btn:hover {
            transform: translateY(-2px);
            border-color: var(--border-focus);
        }

        .main-header {
            text-align: center;
            margin-bottom: 40px;
            color: var(--text-inverse);
        }

        .logo {
            font-size: 3.5rem;
            font-weight: 800;
            margin-bottom: 15px;
            background: linear-gradient(45deg, var(--neon-cyan), #bf00ff);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .section {
            background: var(--bg-secondary);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 25px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
            backdrop-filter: blur(15px);
            border: 1px solid var(--border-color);
        }

        .card {
            background: var(--bg-card);
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            border: 1px solid var(--border-color);
        }

        .login-form {
            max-width: 400px;
            margin: 0 auto;
        }

        .input-group {
            margin-bottom: 20px;
        }

        .input-group label {
            display: block;
            margin-bottom: 8px;
            color: var(--text-secondary);
            font-weight: 600;
        }

        .input-group input {
            width: 100%;
            padding: 14px 16px;
            border: 2px solid var(--border-color);
            border-radius: 10px;
            background: var(--bg-card);
            color: var(--text-primary);
            font-size: 1rem;
            transition: all 0.3s ease;
        }

        .input-group input:focus {
            outline: none;
            border-color: var(--border-focus);
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .primary-btn {
            background: var(--accent-primary);
            color: var(--text-inverse);
            border: none;
            padding: 16px 32px;
            border-radius: 12px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 100%;
        }

        .primary-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
        }

        .primary-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .secondary-btn {
            background: transparent;
            color: var(--text-primary);
            border: 2px solid var(--border-color);
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .secondary-btn:hover {
            border-color: var(--border-focus);
            background: rgba(102, 126, 234, 0.1);
        }

        .status-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 20px;
            background: var(--bg-card);
            border-radius: 12px;
            margin-bottom: 20px;
            border: 1px solid var(--border-color);
        }

        .status-indicator {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .status-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: var(--status-offline);
            animation: pulse 2s infinite;
        }

        .status-dot.online {
            background: var(--status-online);
        }

        .chat-container {
            display: flex;
            flex-direction: column;
            height: 400px;
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
            background: var(--bg-card);
            border-radius: 10px;
            margin-bottom: 15px;
            border: 1px solid var(--border-color);
        }

        .message {
            margin-bottom: 15px;
            padding: 12px 16px;
            border-radius: 12px;
            max-width: 80%;
        }

        .message.own {
            background: var(--accent-primary);
            color: var(--text-inverse);
            margin-left: auto;
        }

        .message.other {
            background: var(--bg-secondary);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
        }

        .message-input {
            display: flex;
            gap: 10px;
        }

        .message-input input {
            flex: 1;
            padding: 12px;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            background: var(--bg-card);
            color: var(--text-primary);
        }

        .send-btn {
            background: var(--accent-success);
            color: var(--text-inverse);
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .send-btn:hover:not(:disabled) {
            transform: translateY(-2px);
        }

        .send-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .animation-canvas {
            width: 100%;
            height: 200px;
            background: var(--bg-card);
            border: 2px solid var(--border-color);
            border-radius: 10px;
            margin: 20px 0;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }

        .user-node {
            width: 50px;
            height: 50px;
            background: var(--neon-cyan);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            position: absolute;
            font-size: 20px;
            animation: pulse 2s infinite;
        }

        .user-alice { left: 20%; }
        .user-bob { right: 20%; }

        .connection-line {
            position: absolute;
            top: 50%;
            left: 25%;
            right: 25%;
            height: 3px;
            background: var(--neon-cyan);
            opacity: 0.7;
        }

        .handshake-active .connection-line {
            animation: glow 2s infinite;
            background: #ffd700;
        }

        .hidden {
            display: none !important;
        }

        .error-message {
            padding: 12px;
            background: rgba(245, 101, 101, 0.1);
            border: 1px solid var(--status-error);
            border-radius: 8px;
            color: var(--status-error);
            margin-top: 15px;
        }

        .success-message {
            padding: 12px;
            background: rgba(72, 187, 120, 0.1);
            border: 1px solid var(--status-online);
            border-radius: 8px;
            color: var(--status-online);
            margin-top: 15px;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        @keyframes glow {
            0%, 100% { box-shadow: 0 0 5px currentColor; }
            50% { box-shadow: 0 0 20px currentColor; }
        }

        .spin {
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        @media (max-width: 768px) {
            .container {
                padding: 15px;
            }
            .logo {
                font-size: 2.5rem;
            }
        }
    </style>
</head>
<body>
    <!-- Theme Toggle -->
    <div class="theme-toggle">
        <button id="themeToggle" class="theme-btn">
            <span id="themeIcon">🌙</span>
            <span id="themeText">Dark</span>
        </button>
    </div>

    <div class="container">
        <!-- Header -->
        <header class="main-header">
            <h1 class="logo">🔐 SecureTalk Edu</h1>
            <p class="tagline">Educational Cybersecurity Platform</p>
            <div style="display: inline-block; padding: 8px 16px; background: rgba(0,245,255,0.1); border: 2px solid var(--neon-cyan); border-radius: 20px; color: var(--neon-cyan); margin-top: 15px;">
                🛡️ End-to-End Encrypted
            </div>
        </header>

        <!-- Login Section -->
        <div id="loginSection" class="section">
            <div style="text-align: center; margin-bottom: 25px;">
                <h2>🚪 Join Secure Chat</h2>
                <p>Enter your credentials to access the encrypted messaging platform</p>
            </div>
            
            <form id="loginForm" class="login-form">
                <div class="input-group">
                    <label for="usernameInput">Username</label>
                    <input type="text" id="usernameInput" placeholder="Enter username (2+ characters)..." maxlength="50" required>
                    <div style="font-size: 0.85rem; color: var(--text-muted); margin-top: 5px;">Minimum 2 characters</div>
                </div>
                
                <div class="input-group">
                    <label for="passwordInput">Password</label>
                    <input type="password" id="passwordInput" placeholder="Enter password (6+ characters)..." maxlength="200" required>
                    <div style="font-size: 0.85rem; color: var(--text-muted); margin-top: 5px;">Minimum 6 characters</div>
                </div>
                
                <div style="margin: 20px 0;">
                    <label style="display: flex; align-items: center; cursor: pointer;">
                        <input type="checkbox" id="rememberMe" style="margin-right: 10px;">
                        Remember username
                    </label>
                </div>
                
                <button type="submit" id="joinBtn" class="primary-btn">
                    <span id="joinBtnText">🚀 Join Chat</span>
                    <span id="joinBtnLoader" class="hidden spin">⟳</span>
                </button>
                
                <div id="loginError" class="error-message hidden"></div>
                <div id="loginSuccess" class="success-message hidden"></div>
            </form>
        </div>

        <!-- Chat Section -->
        <div id="chatSection" class="section hidden">
            <!-- Status Bar -->
            <div class="status-bar">
                <div class="status-indicator">
                    <span id="statusDot" class="status-dot"></span>
                    <span id="statusText">Connecting...</span>
                </div>
                <div>
                    <span id="currentUsername"></span>
                    <span id="userBadge" class="hidden" style="padding: 4px 8px; background: var(--accent-success); color: white; border-radius: 10px; font-size: 0.75rem; margin-left: 10px;"></span>
                    <button id="disconnectBtn" class="secondary-btn" style="margin-left: 15px;">Disconnect</button>
                </div>
            </div>

            <!-- Animation Canvas -->
            <div class="card">
                <h3 style="margin-bottom: 15px;">🔄 Cryptographic Visualization</h3>
                <div id="animationCanvas" class="animation-canvas">
                    <div class="user-node user-alice">👤</div>
                    <div id="connectionLine" class="connection-line"></div>
                    <div class="user-node user-bob">👤</div>
                    <div id="animationStatus" style="position: absolute; top: 20%; font-size: 14px; color: var(--neon-cyan);">
                        Phase: <span id="currentPhase">Initializing...</span>
                    </div>
                </div>
            </div>

            <!-- Chat Container -->
            <div class="card chat-container">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <h3>💬 Encrypted Messages</h3>
                    <span id="messageCount">0 messages</span>
                </div>
                <div id="chatMessages" class="chat-messages"></div>
                <div class="message-input">
                    <input type="text" id="messageInput" placeholder="Type your encrypted message..." maxlength="500" disabled>
                    <button id="sendBtn" class="send-btn" disabled>Send 📤</button>
                </div>
                <div style="font-size: 0.8rem; color: var(--text-muted); margin-top: 5px; text-align: right;">
                    <span id="inputCounter">0/500</span>
                </div>
            </div>

            <!-- Connection Info -->
            <div class="card">
                <h4 style="margin-bottom: 15px;">🔗 Connection Details</h4>
                <div>
                    <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                        <span>Online Users:</span>
                        <span id="userCount">0</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                        <span>Room Status:</span>
                        <span id="roomStatus">Waiting...</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                        <span>Encryption:</span>
                        <span id="encryptionStatus">Not Ready</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Socket.IO -->
    <script src="/socket.io/socket.io.js"></script>

    <script>
        console.log('🚀 SecureTalk Client Loading...');

        // Global variables
        let socket = null;
        let username = '';
        let password = '';
        let isAuthenticated = false;
        let isConnected = false;
        let messageCount = 0;
        let handshakeStep = 0;

        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', function() {
            console.log('📄 DOM loaded, initializing...');
            initializeApp();
        });

        function initializeApp() {
            console.log('🔧 Initializing application...');
            
            // Load theme
            loadTheme();
            
            // Load remembered username
            loadRememberedUsername();
            
            // Setup event listeners
            setupEventListeners();
            
            // Initialize socket
            initSocket();
            
            console.log('✅ Application initialized!');
        }

        // Theme Management
        function loadTheme() {
            const savedTheme = localStorage.getItem('securetalk-theme') || 'light';
            setTheme(savedTheme);
        }

        function setTheme(theme) {
            document.documentElement.setAttribute('data-theme', theme);
            localStorage.setItem('securetalk-theme', theme);
            
            const themeIcon = document.getElementById('themeIcon');
            const themeText = document.getElementById('themeText');
            
            if (theme === 'dark') {
                themeIcon.textContent = '☀️';
                themeText.textContent = 'Light';
            } else {
                themeIcon.textContent = '🌙';
                themeText.textContent = 'Dark';
            }
            
            console.log('🎨 Theme set to:', theme);
        }

        function loadRememberedUsername() {
            const remembered = localStorage.getItem('securetalk-username');
            if (remembered) {
                document.getElementById('usernameInput').value = remembered;
                document.getElementById('rememberMe').checked = true;
            }
        }

        // Event Listeners
        function setupEventListeners() {
            console.log('🔗 Setting up event listeners...');

            // Theme toggle
            document.getElementById('themeToggle').addEventListener('click', function() {
                const current = document.documentElement.getAttribute('data-theme') || 'light';
                const newTheme = current === 'light' ? 'dark' : 'light';
                setTheme(newTheme);
            });

            // Login form
            document.getElementById('loginForm').addEventListener('submit', function(e) {
                e.preventDefault();
                handleJoin();
            });

            document.getElementById('joinBtn').addEventListener('click', function(e) {
                e.preventDefault();
                handleJoin();
            });

            // Message input
            document.getElementById('messageInput').addEventListener('input', function() {
                updateInputCounter();
                updateSendButton();
            });

            document.getElementById('messageInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    sendMessage();
                }
            });

            // Send button
            document.getElementById('sendBtn').addEventListener('click', function() {
                sendMessage();
            });

            // Disconnect button
            document.getElementById('disconnectBtn').addEventListener('click', function() {
                disconnect();
            });
        }

        // Socket Connection
        function initSocket() {
            console.log('🔌 Connecting to server...');
            
            socket = io();
            
            socket.on('connect', function() {
                console.log('✅ Connected to server:', socket.id);
                updateStatus('Connected to server', 'connecting');
            });

            socket.on('disconnect', function() {
                console.log('❌ Disconnected from server');
                updateStatus('Disconnected', 'offline');
                isAuthenticated = false;
                isConnected = false;
            });

            socket.on('joinSuccess', function(data) {
                console.log('✅ Join successful:', data);
                handleJoinSuccess(data);
            });

            socket.on('joinError', function(error) {
                console.error('❌ Join error:', error);
                handleJoinError(error);
            });

            socket.on('handshakeStep', function(data) {
                console.log('🤝 Handshake step:', data.step);
                handleHandshakeStep(data);
            });

            socket.on('messageReceived', function(data) {
                console.log('📨 Message received:', data);
                addMessageToChat(data.from, data.decrypted, data.timestamp, false);
            });

            socket.on('userListUpdate', function(users) {
                console.log('👥 Users updated:', users.length);
                updateUserCount(users.length);
            });
        }

        // Authentication
        function handleJoin() {
            const usernameInput = document.getElementById('usernameInput');
            const passwordInput = document.getElementById('passwordInput');
            
            username = usernameInput.value.trim();
            password = passwordInput.value.trim();
            
            console.log('🚪 Attempting join for:', username);

            if (!validateInput(username, password)) return;
            if (!socket || !socket.connected) {
                showError('Not connected to server');
                return;
            }

            // Handle remember me
            if (document.getElementById('rememberMe').checked) {
                localStorage.setItem('securetalk-username', username);
            } else {
                localStorage.removeItem('securetalk-username');
            }

            // Show loading
            setLoginLoading(true);
            hideMessages();

            // Send join request
            socket.emit('join', { username: username, password: password });
        }

        function validateInput(username, password) {
            if (username.length < 2) {
                showError('Username must be at least 2 characters');
                return false;
            }
            if (password.length < 6) {
                showError('Password must be at least 6 characters');
                return false;
            }
            return true;
        }

        function handleJoinSuccess(data) {
            console.log('🎉 Join successful!');
            setLoginLoading(false);
            isAuthenticated = true;
            isConnected = true;

            showSuccess(`Welcome ${data.isNewUser ? 'new' : 'returning'} user!`);

            // Update UI
            document.getElementById('currentUsername').textContent = data.username;
            const badge = document.getElementById('userBadge');
            badge.textContent = data.isNewUser ? 'New' : 'Returning';
            badge.classList.remove('hidden');

            // Switch to chat
            setTimeout(function() {
                document.getElementById('loginSection').classList.add('hidden');
                document.getElementById('chatSection').classList.remove('hidden');
                document.getElementById('messageInput').disabled = false;
                updateStatus('Waiting for another user...', 'waiting');
            }, 1500);
        }

        function handleJoinError(error) {
            console.error('❌ Join failed:', error);
            setLoginLoading(false);
            showError(error.message);
        }

        // Handshake
        function handleHandshakeStep(data) {
            handshakeStep = data.step;
            const canvas = document.getElementById('animationCanvas');
            const phase = document.getElementById('currentPhase');
            const line = document.getElementById('connectionLine');
            
            switch (data.step) {
                case 1:
                    updateStatus('🔑 Generating keys...', 'handshake');
                    phase.textContent = 'Key Generation';
                    break;
                case 2:
                    updateStatus('🔄 Exchanging keys...', 'handshake');
                    phase.textContent = 'Key Exchange';
                    canvas.classList.add('handshake-active');
                    break;
                case 3:
                    updateStatus('🛡️ Secure channel ready!', 'online');
                    phase.textContent = 'Ready for Communication';
                    document.getElementById('encryptionStatus').textContent = 'AES-256 Ready';
                    document.getElementById('roomStatus').textContent = 'Connected';
                    isConnected = true;
                    updateSendButton();
                    break;
            }
        }

        // Messaging
        function sendMessage() {
            const input = document.getElementById('messageInput');
            const message = input.value.trim();
            
            if (!message || !isAuthenticated || !isConnected) {
                console.log('❌ Cannot send message');
                return;
            }

            console.log('📤 Sending:', message);
            
            // Add to chat immediately
            addMessageToChat('You', message, new Date().toISOString(), true);
            
            // Send to server
            socket.emit('sendMessage', { message: message, password: password });
            
            // Clear input
            input.value = '';
            updateInputCounter();
            updateSendButton();
        }

        function addMessageToChat(sender, message, timestamp, isOwn) {
            const messagesDiv = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${isOwn ? 'own' : 'other'}`;
            
            const time = new Date(timestamp).toLocaleTimeString();
            messageDiv.innerHTML = `
                <div style="font-weight: bold; margin-bottom: 5px; font-size: 0.9rem;">${sender}</div>
                <div>${escapeHtml(message)}</div>
                <div style="font-size: 0.7rem; opacity: 0.7; margin-top: 5px;">${time}</div>
            `;
            
            messagesDiv.appendChild(messageDiv);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
            
            messageCount++;
            document.getElementById('messageCount').textContent = `${messageCount} messages`;
        }

        // UI Updates
        function updateStatus(text, type) {
            document.getElementById('statusText').textContent = text;
            const dot = document.getElementById('statusDot');
            
            dot.className = 'status-dot';
            if (type === 'online') {
                dot.classList.add('online');
            }
        }

        function updateUserCount(count) {
            document.getElementById('userCount').textContent = count;
            if (count >= 2 && handshakeStep >= 3) {
                isConnected = true;
                updateSendButton();
            }
        }

        function updateInputCounter() {
            const input = document.getElementById('messageInput');
            const counter = document.getElementById('inputCounter');
            const length = input.value.length;
            counter.textContent = `${length}/500`;
        }

        function updateSendButton() {
            const btn = document.getElementById('sendBtn');
            const input = document.getElementById('messageInput');
            const hasMessage = input.value.trim().length > 0;
            btn.disabled = !hasMessage || !isAuthenticated || !isConnected;
        }

        function disconnect() {
            if (socket) socket.disconnect();
            
            // Reset state
            isAuthenticated = false;
            isConnected = false;
            messageCount = 0;
            handshakeStep = 0;
            
            // Reset UI
            document.getElementById('chatSection').classList.add('hidden');
            document.getElementById('loginSection').classList.remove('hidden');
            document.getElementById('passwordInput').value = '';
            document.getElementById('chatMessages').innerHTML = '';
            document.getElementById('messageCount').textContent = '0 messages';
            document.getElementById('animationCanvas').classList.remove('handshake-active');
            
            hideMessages();
            
            // Reconnect
            setTimeout(initSocket, 500);
        }

        // UI Helpers
        function setLoginLoading(loading) {
            const btn = document.getElementById('joinBtn');
            const text = document.getElementById('joinBtnText');
            const loader = document.getElementById('joinBtnLoader');
            
            btn.disabled = loading;
            text.classList.toggle('hidden', loading);
            loader.classList.toggle('hidden', !loading);
        }

        function showError(message) {
            const errorDiv = document.getElementById('loginError');
            errorDiv.textContent = message;
            errorDiv.classList.remove('hidden');
            document.getElementById('loginSuccess').classList.add('hidden');
        }

        function showSuccess(message) {
            const successDiv = document.getElementById('loginSuccess');
            successDiv.textContent = message;
            successDiv.classList.remove('hidden');
            document.getElementById('loginError').classList.add('hidden');
        }

        function hideMessages() {
            document.getElementById('loginError').classList.add('hidden');
            document.getElementById('loginSuccess').classList.add('hidden');
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Debug function
        window.debugClient = function() {
            console.log('=== DEBUG INFO ===');
            console.log('Socket:', socket ? (socket.connected ? 'Connected' : 'Disconnected') : 'None');
            console.log('Authenticated:', isAuthenticated);
            console.log('Connected:', isConnected);
            console.log('Username:', username);
            console.log('Handshake step:', handshakeStep);
            console.log('Message count:', messageCount);
        };

        console.log('✅ SecureTalk Client Loaded!');
        console.log('📞 Run debugClient() for debug info');
    </script>
</body>
</html>